{
    "title": "JSON schema for configuring PCIT CI/CD",
    "$schema": "http://json-schema.org/draft-07/schema",
    "$id": "https://ci.khs1994.com",
    "$comment": "https://docs.ci.khs1994.com/usage/",
    "description": "see https://docs.ci.khs1994.com/usage/",
    "type": "object",
    "fileMatch": [
        ".pcit.yaml",
        ".pcit.yml",
        ".pcit/**.yaml",
        ".pcit/**.yml"
    ],
    "definitions": {
        "read_only": {
           "type": "boolean",
           "description": "Mount the container's root filesystem as read only",
           "default": false
        },
        "plugins": {
            "type": "object",
            "oneOf": [
                {
                    "description": "The github-release plugin is used to publish files and artifacts to GitHub Release.",
                    "properties": {
                        "image": {
                            "type": "string",
                            "const": "pcit/github-release",
                            "description": "plugin image name"
                        },
                        "with": {
                            "type": "object",
                            "description": "plugin settings",
                            "properties": {
                                "token": {
                                    "type": "string",
                                    "description": "GitHub oauth token with public_repo or repo permission, see https://help.github.com/articles/creating-a-personal-access-token-for-the-command-line/",
                                    "default": "${GITHUB_TOKEN}"
                                },
                                "repo": {
                                    "type": "string",
                                    "description": "github repository name"
                                },
                                "files": {
                                    "type": "array",
                                    "uniqueItems": true,
                                    "description": "files to upload to GitHub Release, globs are allowed",
                                    "items": {
                                        "type": "string"
                                    },
                                    "minItems": 1,
                                    "default": "dist/*",
                                    "examples": [
                                        "dist/*",
                                        "bin/binary.exe"
                                    ]
                                },
                                "checksum": {
                                    "type": "array",
                                    "uniqueItems": true,
                                    "minItems": 1,
                                    "description": "checksum takes hash methods to include in your GitHub release for the files specified.",
                                    "items": {
                                        "enum": [
                                            "md5",
                                            "sha1",
                                            "sha256",
                                            "sha512",
                                            "adler32",
                                            "crc32"
                                        ]
                                    },
                                    "default": [
                                        [
                                            "sha256"
                                        ]
                                    ]
                                },
                                "checksum_file": {
                                    "type": "string",
                                    "description": "name used for checksum file. \"CHECKSUM\" is replaced with the chosen method",
                                    "default": "CHECKSUMsum.txt"
                                },
                                "checksum_flatten": {
                                    "type": "boolean",
                                    "description": "include only the basename of the file in the checksum file",
                                    "default": false
                                },
                                "draft": {
                                    "type": "boolean",
                                    "description": "create a draft release if set to true",
                                    "default": false
                                },
                                "prerelease": {
                                    "type": "boolean",
                                    "description": "set the release as prerelease if set to true",
                                    "default": false
                                },
                                "file_exists": {
                                    "type": "string",
                                    "description": "what to do if an file asset already exists",
                                    "enum": [
                                        "overwrite",
                                        "skip",
                                        "fail"
                                    ],
                                    "default": "overwrite"
                                },
                                "target_commitish": {
                                    "type": "string",
                                    "description": "",
                                    "examples": [
                                        "refs/tags/nightly"
                                    ]
                                },
                                "note": {
                                    "type": "string",
                                    "description": "file or string with notes for the release, see https://help.github.com/en/github/administering-a-repository/managing-releases-in-a-repository#creating-a-release"
                                },
                                "title": {
                                    "type": "string",
                                    "description": "file or string for the title shown in the github release, see https://help.github.com/en/github/administering-a-repository/managing-releases-in-a-repository#creating-a-release"
                                },
                                "overwrite": {
                                    "type": "boolean",
                                    "description": "force overwrite existing release informations (only title and note)",
                                    "default": false
                                }
                            },
                            "additionalProperties": false,
                            "required": [
                                "token",
                                "files"
                            ]
                        },
                        "if": {
                            "$ref": "#/definitions/if"
                        },
                        "pull": {
                            "$ref": "#/definitions/pull"
                        },
                        "privileged": {
                            "$ref": "#/definitions/privileged"
                        },
                        "read_only": {
                            "$ref": "#/definitions/read_only"
                        },
                        "additionalProperties": false
                    },
                    "required": [
                        "image"
                    ],
                    "additionalProperties": false,
                    "type": "object"
                },
                {
                    "properties": {
                        "image": {
                            "type": "string",
                            "const": "pcit/demo",
                            "description": "plugin image name"
                        },
                        "with": {
                            "properties": {
                                "var": {
                                    "type": "string",
                                    "description": "value is string",
                                    "default": "1"
                                },
                                "var_array": {
                                    "type": "array",
                                    "uniqueItems": true,
                                    "minItems": 1,
                                    "description": "value is array",
                                    "default": [
                                        "a=1",
                                        "b=2"
                                    ]
                                },
                                "var_obj": {
                                    "type": "object",
                                    "description": "value is object",
                                    "default": {
                                        "k1": "v1",
                                        "k2": "v2"
                                    }
                                }
                            },
                            "description": "plugin settings",
                            "additionalProperties": false
                        },
                        "if": {
                            "$ref": "#/definitions/if"
                        },
                        "pull": {
                            "$ref": "#/definitions/pull"
                        },
                        "privileged": {
                            "$ref": "#/definitions/privileged"
                        },
                        "read_only": {
                            "$ref": "#/definitions/read_only"
                        },
                        "additionalProperties": false
                    },
                    "additionalProperties": false,
                    "description": "this is a pcit demo plugin",
                    "required": [
                        "image"
                    ],
                    "type": "object"
                },
                {
                    "properties": {
                        "image": {
                            "type": "string",
                            "const": "pcit/upload-artifact",
                            "description": "pcit upload artifact plugin"
                        },
                        "with": {
                            "properties": {
                                "name": {
                                    "type": "string",
                                    "description": "artifact name"
                                },
                                "path": {
                                    "type": "string",
                                    "description": "artifact local path"
                                }
                            },
                            "required": [
                                "name",
                                "path"
                            ],
                            "description": "plugin settings",
                            "additionalProperties": false
                        },
                        "if": {
                            "$ref": "#/definitions/if"
                        },
                        "pull": {
                            "$ref": "#/definitions/pull"
                        },
                        "privileged": {
                            "$ref": "#/definitions/privileged"
                        },
                        "read_only": {
                            "$ref": "#/definitions/read_only"
                        },
                        "additionalProperties": false
                    },
                    "additionalProperties": false,
                    "description": "pcit upload artifact plugin",
                    "required": [
                        "image",
                        "with"
                    ],
                    "type": "object"
                }
            ]
        },
        "pull": {
            "description": "see https://docs.ci.khs1994.com/usage/steps.html#_4-pull",
            "type": "boolean",
            "default": false
        },
        "privileged": {
            "description": "see https://docs.ci.khs1994.com/usage/steps.html#_7-privileged",
            "type": "boolean",
            "default": false
        },
        "step_settings": {
            "type": "object",
            "description": "step settings",
            "patternProperties": {
                "^[_a-zA-Z][a-zA-Z0-9_-]*$": {
                    "oneOf": [
                        {
                            "type": "string",
                            "description": "value is string"
                        },
                        {
                            "type": "array",
                            "uniqueItems": true,
                            "description": "value is array"
                        },
                        {
                            "type": "object",
                            "description": "value is object"
                        },
                        {
                            "type": "boolean",
                            "description": "value is boolean"
                        },
                        {
                            "type": "integer",
                            "description": "value is boolean"
                        }
                    ]
                }
            }
        },
        "image": {
            "type": "string",
            "description": "step container image name",
            "not": {
                "enum": [
                    "pcit/github-release",
                    "pcit/demo"
                ]
            }
        },
        "command": {
            "oneOf": [
                {
                    "type": "string",
                    "description": "defined command with string, see https://docs.ci.khs1994.com/usage/steps.html#_2-run"
                },
                {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "description": "defined command with array, see https://docs.ci.khs1994.com/usage/steps.html#_2-run"
                }
            ]
        },
        "service": {
            "anyOf": [
                {
                    "type": "null",
                    "description": "run service container with default settings"
                },
                {
                    "type": "object",
                    "description": "run service container with custom settings",
                    "properties": {
                        "env": {
                            "$ref": "#/definitions/env"
                        },
                        "image": {
                            "type": "string",
                            "description": "service container image name"
                        },
                        "entrypoint": {
                            "type": "array"
                        },
                        "command": {
                            "type": "array"
                        }
                    },
                    "additionalProperties": false
                }
            ]
        },
        "env": {
            "type": "array",
            "items": {
                "type": "string"
            },
            "uniqueItems": true,
            "description": "example\n env:\n- k=v\nsee https://docs.ci.khs1994.com/usage/steps.html#_3-env"
        },
        "branch": {
            "oneOf": [
                {
                    "type": "string",
                    "description": "setting branch with string"
                },
                {
                    "type": "array",
                    "uniqueItems": true,
                    "description": "setting branch with array"
                },
                {
                    "type": "object",
                    "properties": {
                        "include": {
                            "oneOf": [
                                {
                                    "type": "string",
                                    "description": "setting branch include with string"
                                },
                                {
                                    "type": "array",
                                    "uniqueItems": true,
                                    "minItems": 1,
                                    "description": "setting branch include with array"
                                }
                            ]
                        }
                    },
                    "required": [
                        "include"
                    ],
                    "additionalProperties": false
                },
                {
                    "type": "object",
                    "properties": {
                        "exclude": {
                            "oneOf": [
                                {
                                    "type": "string",
                                    "description": "setting branch exclude with string"
                                },
                                {
                                    "type": "array",
                                    "uniqueItems": true,
                                    "minItems": 1,
                                    "description": "setting branch exclude with array"
                                }
                            ]
                        }
                    },
                    "required": [
                        "exclude"
                    ],
                    "additionalProperties": false
                }
            ]
        },
        "git": {
            "type": "object",
            "description": "setting git clone, see https://docs.ci.khs1994.com/usage/clone.html",
            "properties": {
                "image": {
                    "type": "string",
                    "description": "run git clone container image name",
                    "default": "pcit/git"
                },
                "depth": {
                    "type": "integer",
                    "description": "clone depth",
                    "default": 25
                },
                "hosts": {
                    "$ref": "#/definitions/hosts"
                },
                "recursive": {
                    "type": "boolean",
                    "description": "clone submodules",
                    "default": false
                },
                "skip_verify": {
                    "type": "boolean",
                    "description": "skip tls verification",
                    "default": false
                },
                "tags": {
                    "type": "boolean",
                    "description": "clone tags",
                    "default": false
                },
                "submodule_override": {
                    "type": "object",
                    "description": "submodule overrides, example:\n path: git_url"
                },
                "disable": {
                    "type": "boolean",
                    "description": "disable git clone",
                    "default": false
                }
            },
            "additionalProperties": false
        },
        "hosts": {
            "type": "array",
            "uniqueItems": true,
            "description": "example:\n\nhosts:\n- \"pcit.dev:127.0.0.1\"\n\nsee https://docs.docker.com/compose/compose-file/#extra_hosts",
            "items": {
                "type": "string"
            },
            "examples": [
                [
                    "pcit.dev:127.0.0.1"
                ]
            ]
        },
        "platform": {
            "enum": [
                "linux/amd64",
                "linux/arm64",
                "linux/ppc64le",
                "linux/s390x",
                "linux/386",
                "linux/arm/v7",
                "linux/arm/v6",
                "windows/amd64"
            ],
            "description": "container platform, see https://github.com/containerd/containerd/blob/master/platforms/platforms.go"
        },
        "status": {
            "enum": [
                "failure",
                "success",
                "changed"
            ]
        },
        "event": {
            "enum": [
                "push",
                "pull_request",
                "tag",
                "cron"
            ]
        },
        "if_include": {
            "type": "object",
            "properties": {
                "include": {
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "array",
                            "uniqueItems": true,
                            "minItems": 1
                        }
                    ]
                }
            },
            "required": [
                "include"
            ],
            "additionalProperties": false
        },
        "if_exclude": {
            "type": "object",
            "properties": {
                "exclude": {
                    "oneOf": [
                        {
                            "type": "string"
                        },
                        {
                            "type": "array",
                            "uniqueItems": true,
                            "minItems": 1
                        }
                    ]
                }
            },
            "required": [
                "exclude"
            ],
            "additionalProperties": false
        },
        "if_event": {
            "oneOf": [
                {
                    "type": "string",
                    "$ref": "#/definitions/event"
                },
                {
                    "type": "array",
                    "uniqueItems": true,
                    "minItems": 1,
                    "items": {
                        "$ref": "#/definitions/event"
                    }
                }
            ]
        },
        "if_event_include": {
            "type": "object",
            "properties": {
                "include": {
                    "$ref": "#/definitions/if_event"
                }
            },
            "required": [
                "include"
            ],
            "additionalProperties": false
        },
        "if_event_exclude": {
            "type": "object",
            "properties": {
                "exclude": {
                    "$ref": "#/definitions/if_event"
                }
            },
            "required": [
                "exclude"
            ],
            "additionalProperties": false
        },
        "if_platform": {
            "oneOf": [
                {
                    "type": "string",
                    "$ref": "#/definitions/platform"
                },
                {
                    "type": "array",
                    "uniqueItems": true,
                    "minItems": 1,
                    "items": {
                        "$ref": "#/definitions/platform"
                    }
                }
            ]
        },
        "if_platform_include": {
            "type": "object",
            "properties": {
                "include": {
                    "$ref": "#/definitions/if_platform"
                }
            },
            "required": [
                "include"
            ],
            "additionalProperties": false
        },
        "if_platform_exclude": {
            "type": "object",
            "properties": {
                "exclude": {
                    "$ref": "#/definitions/if_platform"
                }
            },
            "required": [
                "exclude"
            ],
            "additionalProperties": false
        },
        "if_status": {
            "oneOf": [
                {
                    "type": "string",
                    "$ref": "#/definitions/status"
                },
                {
                    "type": "array",
                    "uniqueItems": true,
                    "minItems": 1,
                    "items": {
                        "$ref": "#/definitions/status"
                    }
                }
            ]
        },
        "if_status_include": {
            "type": "object",
            "properties": {
                "include": {
                    "$ref": "#/definitions/if_status"
                }
            },
            "required": [
                "include"
            ],
            "additionalProperties": false
        },
        "if_status_exclude": {
            "type": "object",
            "properties": {
                "exclude": {
                    "$ref": "#/definitions/if_status"
                }
            },
            "required": [
                "exclude"
            ],
            "additionalProperties": false
        },
        "if": {
            "type": "object",
            "description": "see https://docs.ci.khs1994.com/usage/steps.html#_6-if",
            "properties": {
                "status": {
                    "description": "string or array, one of \nfailure \nsuccess \nchanged",
                    "oneOf": [
                        {
                            "type": "string",
                            "$ref": "#/definitions/status",
                            "examples": [
                                "failure"
                            ]
                        },
                        {
                            "type": "array",
                            "uniqueItems": true,
                            "items": {
                                "$ref": "#/definitions/status"
                            },
                            "examples": [
                                [
                                    "failure"
                                ]
                            ]
                        },
                        {
                            "$ref": "#/definitions/if_status_include"
                        },
                        {
                            "$ref": "#/definitions/if_status_exclude"
                        }
                    ]
                },
                "event": {
                    "description": "string or array, one of \npush \npull_request \ntag \ncron",
                    "oneOf": [
                        {
                            "type": "string",
                            "$ref": "#/definitions/event",
                            "examples": [
                                "push"
                            ]
                        },
                        {
                            "type": "array",
                            "uniqueItems": true,
                            "items": {
                                "$ref": "#/definitions/event"
                            },
                            "examples": [
                                [
                                    "push",
                                    "tag"
                                ]
                            ]
                        },
                        {
                            "$ref": "#/definitions/if_event_include"
                        },
                        {
                            "$ref": "#/definitions/if_event_exclude"
                        }
                    ]
                },
                "platform": {
                    "oneOf": [
                        {
                            "type": "string",
                            "$ref": "#/definitions/platform",
                            "description": "set container platform with string"
                        },
                        {
                            "type": "array",
                            "uniqueItems": true,
                            "items": {
                                "$ref": "#/definitions/platform"
                            },
                            "description": "set container platform with array"
                        },
                        {
                            "$ref": "#/definitions/if_platform_include"
                        },
                        {
                            "$ref": "#/definitions/if_platform_exclude"
                        }
                    ]
                },
                "branch": {
                    "$ref": "#/definitions/branch"
                },
                "tag": {
                    "$ref": "#/definitions/branch"
                },
                "jobs": {
                    "oneOf": [
                        {
                            "type": "array",
                            "uniqueItems": true,
                            "description": "see https://docs.ci.khs1994.com/usage/steps.html#_6-if",
                            "items": {
                                "type": "object"
                            }
                        },
                        {
                            "type": "object",
                            "description": "only run on this jobs",
                            "properties": {
                                "include": {
                                    "type": "array",
                                    "description": "only run on this jobs",
                                    "items": {
                                        "type": "object"
                                    },
                                    "uniqueItems": true,
                                    "minItems": 1
                                }
                            },
                            "required": [
                                "include"
                            ],
                            "additionalProperties": false
                        },
                        {
                            "type": "object",
                            "description": "don't run on this jobs",
                            "properties": {
                                "exclude": {
                                    "type": "array",
                                    "description": "don't run on this jobs",
                                    "items": {
                                        "type": "object"
                                    },
                                    "uniqueItems": true,
                                    "minItems": 1
                                }
                            },
                            "required": [
                                "exclude"
                            ],
                            "additionalProperties": false
                        }
                    ]
                }
            },
            "additionalProperties": false
        },
        "steps": {
            "anyOf": [
                {
                    "$ref": "#/definitions/plugins"
                },
                {
                    "type": "object",
                    "description": "step, see https://docs.ci.khs1994.com/usage/steps.html",
                    "properties": {
                        "image": {
                            "$ref": "#/definitions/image"
                        },
                        "run": {
                            "$ref": "#/definitions/command"
                        },
                        "shell": {
                            "type": "string",
                            "description": "see https://docs.ci.khs1994.com/usage/steps.html#_5-shell",
                            "enum": [
                                "bash",
                                "sh",
                                "pwsh",
                                "node",
                                "deno",
                                "python"
                            ]
                        },
                        "env": {
                            "$ref": "#/definitions/env"
                        },
                        "with": {
                            "$ref": "#/definitions/step_settings"
                        },
                        "pull": {
                            "$ref": "#/definitions/pull"
                        },
                        "privileged": {
                            "$ref": "#/definitions/privileged"
                        },
                        "if": {
                            "$ref": "#/definitions/if"
                        },
                        "read_only": {
                            "$ref": "#/definitions/read_only"
                        }
                    },
                    "additionalProperties": false
                }
            ]
        },
        "workspace": {
            "type": "object",
            "description": "see https://docs.ci.khs1994.com/usage/workspace.html",
            "properties": {
                "base": {
                    "type": "string"
                },
                "path": {
                    "type": "string"
                }
            },
            "additionalProperties": false
        }
    },
    "allOf": [
        {
            "properties": {
                "language": {
                    "type": "string",
                    "enum": [
                        "php",
                        "node",
                        "node_js",
                        "node.js",
                        "js",
                        "go",
                        "golang",
                        "java"
                    ],
                    "description": "project language, see https://docs.ci.khs1994.com/usage/language.html"
                },
                "clone": {
                    "type": "object",
                    "description": "git clone, see https://docs.ci.khs1994.com/usage/clone.html",
                    "$comment": "https://docs.ci.khs1994.com/usage/clone.html",
                    "properties": {
                        "git": {
                            "type": "object",
                            "description": "setting git clone",
                            "$ref": "#/definitions/git",
                            "additionalProperties": false
                        }
                    },
                    "additionalProperties": false
                },
                "workspace": {
                    "$ref": "#/definitions/workspace"
                },
                "workdir": {
                    "$ref": "#/definitions/workspace"
                },
                "cache": {
                    "type": [
                        "string",
                        "array"
                    ],
                    "items": {
                        "type": "string"
                    },
                    "description": "see https://docs.ci.khs1994.com/usage/cache.html"
                },
                "steps": {
                    "type": "object",
                    "description": "job step, see https://docs.ci.khs1994.com/usage/steps.html",
                    "patternProperties": {
                        "^[a-zA-Z0-9._-]+$": {
                            "oneOf": [
                                {
                                    "type": "object",
                                    "$ref": "#/definitions/steps"
                                },
                                {
                                    "type": "string",
                                    "description": "step only include command with string fomat, see https://docs.ci.khs1994.com/usage/steps.html"
                                },
                                {
                                    "type": "array",
                                    "description": "step only include command with array fomat, see https://docs.ci.khs1994.com/usage/steps.html",
                                    "items": {
                                        "type": "string"
                                    }
                                }
                            ]
                        }
                    },
                    "additionalProperties": false
                },
                "services": {
                    "type": "object",
                    "$comment": "https://docs.ci.khs1994.com/usage/services.html",
                    "description": "Additional containers to host services for a job. These are useful for creating databases or cache services like redis. see https://docs.ci.khs1994.com/usage/services.html",
                    "patternProperties": {
                        "^[a-zA-Z0-9._-]+$": {
                            "$ref": "#/definitions/service"
                        }
                    },
                    "additionalProperties": false
                },
                "jobs": {
                    "type": "object",
                    "$comment": "https://docs.ci.khs1994.com/usage/jobs.html",
                    "description": "jobs, see https://docs.ci.khs1994.com/usage/jobs.html",
                    "patternProperties": {
                        "^[a-zA-Z0-9._]+$": {
                            "type": "array",
                            "uniqueItems": true,
                            "description": "env name",
                            "items": {
                                "type": "string",
                                "description": "env value"
                            },
                            "minItems": 1
                        }
                    }
                },
                "platform": {
                    "type": "array",
                    "$comment": "https://docs.ci.khs1994.com/usage/platform.html",
                    "items": {
                        "$ref": "#/definitions/platform"
                    },
                    "description": "container platform",
                    "minItems": 1,
                    "uniqueItems": true
                },
                "branches": {
                    "$ref": "#/definitions/branch",
                    "$comment": "https://docs.ci.khs1994.com/usage/branches.html",
                    "description": "which branches trigger job, see https://docs.ci.khs1994.com/usage/branches.html"
                },
                "networks": {
                    "type": "object",
                    "$comment": "https://docs.ci.khs1994.com/usage/networks.html",
                    "description": "setting step container network, see https://docs.ci.khs1994.com/usage/networks.html",
                    "properties": {
                        "hosts": {
                            "$ref": "#/definitions/hosts"
                        }
                    },
                    "additionalProperties": false
                },
                "image": {
                    "type": "string",
                    "$comment": "https://docs.ci.khs1994.com/usage/image.html",
                    "description": "set step default image, see https://docs.ci.khs1994.com/usage/image.html"
                }
            },
            "additionalProperties": false
        }
    ],
    "required": [
        "steps"
    ]
}
