<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <script src="https://lib.baomitu.com/jquery/3.3.1/jquery.min.js"></script>
  <title>KhsCI - Builds</title>
</head>
<body>
<header>
  This Is Header
  <br>
  <br>
</header>
<div>
  <button id="current">Current</button>
  <button id="branches">Branches</button>
  <button id="builds">Build History</button>
  <button id="pull_requests">Pull Requests</button>

  <select>
    <option value="settings">Settings</option>
    <option value="requests">Requests</option>
    <option value="caches">Caches</option>
    <option value="trigger_build">Trigger Build</option>
  </select>

</div>
<br>
<div id="display">

</div>
<script>
  url = location.href;

  array = url.split('/');

  baseUrl = "https://" + location.host;

  git_type = array[3];

  username = array[4];

  repo = array[5];

  build_id = 'khsci';

  type_from_url = array[6];

  if (6 === array.length) {
    type_from_url = 'current';
  }

  query = git_type + '/' + username + '/' + repo;

  baseTitle = git_type + ' - ' + username + '/' + repo + ' - KhsCI';

  function display(id, data) {
    $("#display").empty();
    switch (id) {
      case 'current':
        if (0 === data.length) {
          $("#display").append("Not Build Yet");
        } else {
          $("#display").append("<pre>" + data.data + "</pre>");
          //$("#current").trigger('click');
        }
        break;

      case 'builds':
        let url = location.href;

        let array = url.split('/');
        if (8 === array.length) {
          $("#display").append(data.status).append('<pre>' + data.data + '</pre>');

        } else {
          $.each(data, function (id, status) {
            let event_type = status.event_type;
            let build_id = status.id;
            let branch = status.branch;
            let committer_username = status.committer_username;
            let commit_message = status.commit_message;
            let commit_id = status.commit_id;
            let build_status = status.build_status;
            let create_time = status.create_time;
            let end_time = status.end_time;

            $("#display").append(
              "<tr>" +
              "<td>" + build_id + "</td>" +
              "<td>" + event_type + "</td>" +
              "<td>" + branch + "</td>" +
              "<td>" + committer_username + "</td>" +
              "<td>" + commit_message + "</td>" +
              "<td>" + commit_id + "</td>" +
              "<td>" + build_status + "</td>" +
              "<td>" + create_time + "</td>" +
              "<td>" + end_time + "</td>" +
              +"</tr>"
            )

          });
        }
        break;
      case 'branches':

        $.each(data, function (branch, status) {

          $("#display").append(branch);

          $.each(status, function (id, status) {
            id = id.replace('k', '');

            let a_content = "<a href='builds/" + id + "' target='_blank'>" + status + "</a>";

            $("#display").append('<br><br>' + a_content);

          });

          $("#display").append("<hr>");


        });
        break;
    }
  }

  function display_title(id, data) {
    switch (id) {
      case "pull_requests":
        title = 'Pull Requests - ' + baseTitle;
        break;
      case "builds":
        title = 'Builds - ' + baseTitle;
        break;
      default:
        title = baseTitle;
    }

    $("title").text(title);
  }

  /**
   * http://www.zhangxinxu.com/wordpress/2013/06/html5-history-api-pushstate-replacestate-ajax/
   */
  $("button").click(function () {
    let id = $(this).attr('id');

    if ('current' === id) {
      history.replaceState(null, baseTitle, baseUrl + '/' + query);
    } else {
      history.replaceState(null, baseTitle, baseUrl + '/' + query + '/' + id);
    }

    display_title(id);

    $("title").text(title);

    $.ajax({
      type: "POST",
      url: location.href,
      success: function (data) {

        display(id, data);

      }
    })

  });

  $("option").click(function () {
    let id = $(this).attr('value');
    history.replaceState(null, baseTitle, baseUrl + '/' + query + '/' + id);

    $('title').text(baseTitle);

    $.ajax({
      type: "post",
      url: location.href,
      success: function (data) {

        display(id, data);

      }
    })

  });

  $(document).ready(function () {

    display_title(type_from_url);

    $.ajax({

      type: "POST",
      url: location.href,
      success: function (data) {
        display(type_from_url, data);
      }

    })

  });
</script>
</body>
</html>
