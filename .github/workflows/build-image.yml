name: Build Image

on: push

jobs:
  build_image:
    runs-on: ubuntu-latest
    steps:
      - uses: azure/docker-login@v1
        with:
          # login-server: contoso.azurecr.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        if: github.event_name == 'push'
      - uses: docker-practice/actions-setup-docker@master
      - uses: actions/checkout@master
        with:
          fetch-depth: 1
      - run: git clone --depth=1 https://github.com/pcit-ce/ui frontend
        name: Clone frontend
      - run: |
          TAG=`echo $GITHUB_REF | cut -d '/' -f 3`
          docker buildx build -t pcit/pcit -t pcit/pcit:${TAG} --target=php --push .
        env:
          GITHUB_REF: ${{github.ref}}
        name: Build image
      - run: docker run -i --rm --entrypoint=sh pcit/pcit -c "ls /app/pcit"
        name: List files
      - name: Test image
        run: |
          docker run -i --rm pcit/pcit list
